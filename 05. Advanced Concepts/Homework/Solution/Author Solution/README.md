
# Init Containers

1.	Create a set of two **init containers** and one **app container** (in fact modify/extend the example shown during the practice)
2.	The **first init container** should generate the following two lines with **10 seconds** delay.
dd-mm-yyyy hh:mi:ss => begin initialization …
dd-mm-yyyy hh:mi:ss => … done
Please note that the dd-mm-yyyy hh:mi:ss should reflect the actual time the event is taking place
3.	The **second init container** should add one more line like the following.
dd-mm-yyyy hh:mi:ss => launching the application …
Please note that the dd-mm-yyyy hh:mi:ss should reflect the actual time the event is taking place.
4.	The **app container** should be **nginx** based and should **display the three lines** generated by the init containers instead of the **default index page**.

## Solution

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-init
  labels:
    app: pod-init
spec:
  containers:
  - name: cont-app-main
    image: nginx
    ports:
    - containerPort: 80
    volumeMounts:
    - name: data
      mountPath: /usr/share/nginx/html
  initContainers:
  - name: cont-init-1
    image: alpine
    command: ["/bin/sh", "-c"]
    args:
      - echo -e $(date +'%Y-%m-%d %H:%M:%S') '=> begin initialization ...<br />\n' > /data/index.html;
        sleep 10;
        echo -e $(date +'%Y-%m-%d %H:%M:%S') '=> ...done<br />\n' >> /data/index.html;
    volumeMounts:
    - name: data
      mountPath: /data
  - name: cont-init-2
    image: alpine
    command: ["/bin/sh", "-c"]
    args:
      - echo -e $(date +'%Y-%m-%d %H:%M:%S') '=> launching the application ...<br />\n' >> /data/index.html;
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: svc-init
  labels:
    app: svc-init
spec:
  type: NodePort
  ports:
  - port: 80
    nodePort: 30001
    protocol: TCP
  selector:
    app: pod-init
```

# Ingress and TLS

1. Using either **NGINX** or **HAProxy** (the implementation should not differ significantly) **ingress controller** try to modify/extend the **fan out** example shown in the practice to **handle TLS traffic**.
2. Note, that you will need to create a **self-signed certificate** and store it in a **secret** which then to be **used in the ingress**.

## Solution

Generate Self-Signed Certificate

```bash
openssl genrsa -out main.key 4096
openssl req -new -x509 -key main.key -out main.crt -days 365 -subj /CN=demo.lab
```

Generate Secret yaml

```bash
kubectl create secret generic demo-lab-secret --from-file=tls.key=./main.key  --from-file=tls.crt=./main.crt --dry-run=client -o yaml
```

Edit secret type to be: ```kubernetes.io/tls```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: demo-lab-secret
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZCekNDQXUrZ0F3SUJBZ0lVQy81cHlqZUdGZk1kRnBiSXZnWFp1MHBPWnI0d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0V6RVJNQThHQTFVRUF3d0laR1Z0Ynk1c1lXSXdIaGNOTWpFeE1qRTFNVEkxTXpJNFdoY05Nakl4TWpFMQpNVEkxTXpJNFdqQVRNUkV3RHdZRFZRUUREQWhrWlcxdkxteGhZakNDQWlJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnSVBBRENDQWdvQ2dnSUJBS1B3QjhJWk9vY09vTktpR1p3Z0ZsU3hIYVlkTmMxeVJsNVN4NDM0NXhRNlRlMU0KYUg2RkpUTzBwMnFWTm5uMDVLZmpuT2xtRjQreHFoL0k2VmcyUC9vQnpWOVBrRWFGdWZQTlJ0T2NvWERNdnRrNwpuL1I5U1ZndC8rZ3d3b3dmZ1JUVnVpM0dPdjd6dVFzN29oTVpBL3BKWTZBUVF0ZElnNDZycmhpOFQwaXlNeEFKCi9rMDYzQkV2YVBZNnpnT0N1d2t4NlNEMXBKUldFN1REMEw2VkVWSDRZRHZ0Njg0c1Z3encrdWQ1TTh3TnRRM0QKSDVBS1h1RTRvclhGMTdZQUlKeUx3UGZ1MDE1SjFzZzMyazE4YytIM0txT2lTRmxxMXhiNjV5d3Jrb0JMYTBKVworcjZ6dXRwbW0zYUNvTGpsNU8zdEtTemN6cC9XZytCbWJveFNJOXZDS0xxdkliaWhJNWc1YW00OVJ6blk5MExECnBxbzlQUEtnUkNCZjRrZ3VnUkxSSytpbFpVelArS3kxbFBBK1c2TEQ1b050dStnajljSFdTTU1pYm9wQWJYVm4KRTlhbFU5MER3eTJKZGMwK3NkR3hZK0dMZFgySlV1VlQyVHhrRUtsald6WmpNbDZZbGl3ajJocUpmT2tsSlNNcQpxc3c0d0FxU3cvd2FCeTlHRFVaUUswMmx1YjBZckJnVC9GVEJ2Ny9qbUtOa0Y1WEswQmlFWTVqOG9qQ3VTTkJYClZOaWxBdGUrTnphQ1Z2S0NnTm5LUUFDNlRjSUN5dkwrU2tKVmdTcFhSb0RSRTl4Wis2bHhFMGZ0b2R3ZUpvUzEKVldweUNpeVpmSG1JbkM5di9VRzJEeVVIQS9oY2h0WG9SNkQ1dlhqSlFtMW9tbEhURytDRmthQ1NQek5MQWdNQgpBQUdqVXpCUk1CMEdBMVVkRGdRV0JCVExnZDl2MXNEekpLQzNJM2VaRlIzODVROFR0VEFmQmdOVkhTTUVHREFXCmdCVExnZDl2MXNEekpLQzNJM2VaRlIzODVROFR0VEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElDQVFCR0VPa2hNU1pOcFRUb054RjBaZWtjUmtadm9rZWI4bi9jZUtYWmhrcXhLMGFaWE1BUAp2eUJJSzNsQ1BZUEYzam1TRkJTaGs3R2JYVzhEaEh0THpXWldsaVA5V1M0NDd1YUQzSUc0emhVWFRXNTBycHFPCm5wVVBHOHpUdzJ3KzRzb3p1b2V0aGlQQ3R3MHRvWSthQ3R2eHFGNm0rZElGYlA3cjJhTTBJNi8yM3JZWlBwWTYKMlpybHd2L1ZmdXNCVVlUanFVV1FGSElGM1dybERZSm05UEFtSldPK3JkK0dPdTZrWEhocURFZy9HUGdXNHdpRwpWcXNUSGUwUlhhVmJkUTdMNHhvcnFxbUVHTVZjakd2azB3am43aUxiZ2haN2NCMDFicnpYMkJXMjlpd3RoOXZ1Cm91Y3Z1K2VGUVZOYkxoK24yamhsc2liaXlHSFFXNVJnQkNGcDVTcFF4VzZqMzltdmtoa29FbC8rV2VWQnVBcjAKMkRXM2pXQktuZDBBK2kyeEltUlljWE43NUJ2MmorQlAxc29PSFBzWmRIWm5ScGZNaC9waExjS3d3QVJMdDF6UApoeXZnNmltdEt1Y25nNjdVMzZMQXhZWXFVbmovWmswWGFEeXgyblB5YURZMktEM2tla09pNDAwZ25WTlZnREdECjFDUHJ5ZXIyYTU3UHdPL1FmelFoNEUxOFFKQVJWcG5tcVRFb3pjL0NGbFlrclNNb0ZsYnUrdnk0MmhkZEhoTTgKZEFzUXdTWVBvRGx1S2duRG5uQTI2eldxL3B2STVXM0lDNEo1T0cvWHpuckpZcjVla0J2TlVOYkV1VHBxZml1YgpWR2Q4eUtEcGI2aDM2SE9QUUJkQ3JLemNQQzNUR0o0ckJhQnBKaGphdGE0NWVoYTkvak01YkdBQnlnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKSndJQkFBS0NBZ0VBby9BSHdoazZodzZnMHFJWm5DQVdWTEVkcGgwMXpYSkdYbExIamZqbkZEcE43VXhvCmZvVWxNN1NuYXBVMmVmVGtwK09jNldZWGo3R3FIOGpwV0RZLytnSE5YMCtRUm9XNTg4MUcwNXloY015KzJUdWYKOUgxSldDMy82RERDakIrQkZOVzZMY1k2L3ZPNUN6dWlFeGtEK2tsam9CQkMxMGlEanF1dUdMeFBTTEl6RUFuKwpUVHJjRVM5bzlqck9BNEs3Q1RIcElQV2tsRllUdE1QUXZwVVJVZmhnTyszcnppeFhEUEQ2NTNrenpBMjFEY01mCmtBcGU0VGlpdGNYWHRnQWduSXZBOSs3VFhrbld5RGZhVFh4ejRmY3FvNkpJV1dyWEZ2cm5MQ3VTZ0V0clFsYjYKdnJPNjJtYWJkb0tndU9YazdlMHBMTnpPbjlhRDRHWnVqRklqMjhJb3VxOGh1S0VqbURscWJqMUhPZGozUXNPbQpxajA4OHFCRUlGL2lTQzZCRXRFcjZLVmxUTS80ckxXVThENWJvc1BtZzIyNzZDUDF3ZFpJd3lKdWlrQnRkV2NUCjFxVlQzUVBETFlsMXpUNngwYkZqNFl0MWZZbFM1VlBaUEdRUXFXTmJObU15WHBpV0xDUGFHb2w4NlNVbEl5cXEKekRqQUNwTEQvQm9ITDBZTlJsQXJUYVc1dlJpc0dCUDhWTUcvditPWW8yUVhsY3JRR0lSam1QeWlNSzVJMEZkVQoyS1VDMTc0M05vSlc4b0tBMmNwQUFMcE53Z0xLOHY1S1FsV0JLbGRHZ05FVDNGbjdxWEVUUisyaDNCNG1oTFZWCmFuSUtMSmw4ZVlpY0wyLzlRYllQSlFjRCtGeUcxZWhIb1BtOWVNbENiV2lhVWRNYjRJV1JvSkkvTTBzQ0F3RUEKQVFLQ0FnQVNaQUw2eTBtOWpPNk5zcEdjNmh5WE02ZFgwejhONVJ2dnlPbUtDN29na3NuYkxROHI0bFBpRVFvVwo4dFpCcUM5ZWhqSThISy9YOXQ1VzRuc0s0a3NiQ01pNVFIdTI3Wm1HdUNpUjVLaFh0eUJSemxhTFh1S3plYldUCm5xUzBnM1EvbWhwZ3VEUTJGYkZVaVVRTlVHa1owdEhTU3dDMGxmWHNNMlk4Y0NPVXpDamVTOEN6ZVQ3bXpxSy8KdktrUHk4S2ZyWEd4dU56VnB6SmV2UGpWNkhNZzl2UVV4UVFIQlFKZStVbXNYZlJwbDhBUDR5dlBSTnFQK1lLSApVY0o1TUZwNE5WVllldnBMUVkxT3VMVk1yQUZ6Ly81UWpRd0F1L09WS0dCMm5BeTdSN3Fvbm9sU2kyY1N5Ui8zCmszL2tQaVlJYXVxTGxkbTRKS0IydEFjQ3h0UXV6UWVVY2FCVVlFUDkveEVvaG9LS1BTSkRCTVhnamt1TlBNWnkKYk1XZkZUV2NGMjZOYUM0RGdNOUJmVlZMTnZYYlZRQ2ZGb3lVS2F6Um56eDBPb284VnlzdTZOeDVyRjRZVmxXWAoxTk5KNE4xUVQvSWNOZDZkKy9laEdxeWxnQ05XWVF6YmUrNlZmVVJBbFoxNkd1dUZnZUxzYmx1V0FWb0Vvcmc0CmxneDNBMEwwQVRBOHpGK090NmlnUThqY29SUzR3K3MxUHFRdmVjeE5pY3NIWkV1Y2hrSTIzQjZ6YkVBeDJNUlEKWWtpbldWdE1TZzdZOW9peEtKRjFaazlYOFl5aVh2RURtQnV5ZnRJNG1xUXJMQWhVOGpFd25PcEdrdG5GMzUvRApGQVJYaHJNQUw0RENzcHI4dXk5dnQ3cW1YbkkrUDk3c2ZuamRLa1dOekh4S3NBTUl3UUtDQVFFQTBYcElncWRUClVkclZiREVIZkdBRWZvWVlQeGpXSTNjY3FnZFl4Q09iTTl3aHp3TVRpczRhT2dkZ054SmVqSXpSenhRNWs1RDAKZkZXTHFPUU8xSlBrdElrMjRtMFVJVFJlcXN3OHBZd3NEalBzcWRzMnExa2QySjdnZTV4ZmgwZDYxZVk4V0xqago5eEFDZWZmdHJCNVdPaUVQMzJwSEptV1RxMXlrS2NvaTRsemdVeThHSmlGNmtqOE5LbElVQjNIRWppaG1pcUNHCmtEeXNUVFQ5em9zTWwwdVgxVXlqZGFvL2Ruc1FMRUozU0FQSnNGZG8wWUpQNGRSdUt5RUU0aWRJN2VJLzRQWTYKSm94V0x4aklvTnl6SWI2Sk9QYzlWcU02YjlpRktzdkJTS0JjYkN2UnFZdXEyN3pLdWR2TkRSM1FvczZxSW5QUQpsR01NWk5RZkdjODJIUUtDQVFFQXlGaVkyaUszdm1zVnRRVEVYTXJFMHk2VmhSUjN3RFg1VS93dVNVblN3K0htCnpmbmRnVUx4Y1ZyTFhBS3dkNHorMGQwQ2taMFJoWnRjZWxnTVhZSFM1MGJzTTNpMVpPNlV3Y2JRTnREaDh6eGsKSmw2OCs1Y1dEemdvK2swRGFvdXJ3T0RteXVQWFFqSFZNWnlMU0xMMnUreDB2eUpJYzVJL1RnWkp5cndzL2FxUworS2pId1haeUw5REZaWll1amEvNHplc0xNMlF1eHRjakJRVldaZm9rVGFHc2NzdkdmZzI2TzBOOTJxUGlnVzRhCk9MaEw4K0V2T3NjNzJXY2tXVWtIdXAxRld4dmZIbURjSkVqWmpDa2hZSG0yZDg5dUhNaHJBcmxQVXorN2ZSS08KMk1JWmxkSUYrZEcrREZxZmhDUVc4ZWJ2cUFTc0NOMVJhUmdSVm9neWh3S0NBUUJQNFNDTGFnRVV3cTBGMzhCcQpCamRRaEJQMDQ2U3N5M3dMdmxkMEc5dlFMODVZb1dTdlZwNmJxRHBoWmNqV01kREQ5WU5yS1NpQnpTRS9tdytvCnNtalJDMDM1ay96TUdLdE0yQ3I4T2ZLR3kvZ2dZVzU4Y3JRMTZZZlN1ek9XWTRTTTBvb0tqeDZuRk56TTQrVW0KOEQ2VFZnNDJkTkdDNjlNZTBtbnJZYUJoejJiZmNad1hxRWFVUkNUaUVZQi93anRndGprNy9iQ3lpZUJ1WkptdwpURWZWM2NhZFdPY3dOR2FVNktLbkxnVk1XZDFzT0RqSlE3YndkOUEyOUJWbm8vRmtmUlU4MU1naDhQdmdZOFFGCnk0TW5oLy9OMEVIOHFxdmJBS2J2UmRtRHQxcm5DT0tmazVub3h4cExPMno2NW5hcnpzRUQrRVArZ2JLMU5FcFQKempkbEFvSUJBQkQ2Z1Ntclc0c0ZwRGROQ2g4YkNBY2xvWUkvczg1VVJLYjdiaWpEMnRyQzRENkFlR2NsOXpRMgpENW5pbUhYcE93Y3FCYmUxYWZDNnMrR2lhSm5jRUxXTTZ5T0pqVVhhZWp6WnpuZDJ5RTlHeE80RGhWeUU5MWVlCjJNb3RrS2FNNDZkYTUvUTF6dDVMUHRnUGZqWlJCRnYwdEFnbXJhRXR1Yk94RUx2ZnFxaHN0anZnZ2QxQlhuZnkKNTJldWpJOXhaRkovSXRuZUdhQzhScmw4TkZBOEhLdC9rZy9BZVRmaGpmREx6WFNrQXVRWklwdS84cC9lYTVROQpvakxRYk9Jc01EMSthb3hJRm1hS3F0MWdWeDlydE9wcUppNk5JN1hJdmxqaXYzZzhwSFQ3QjZRUy92d1ZhbkE3CmVER3YxR2pzYmcxZUZ0MVVXQWdBU1kvd2ZEZXJIeTBDZ2dFQWRpWm1RcVJra25GRXQ3N3VseEx4NGZQdHB2Y2MKbE13eU5SWmlrSkJpNGRxNEY1S2dxWGh5cDR5YkxRNHlqS1pEU0NudGU0TE4vY2h2blBoMUNnSzltbHNudUJIeQpwWTV5WklIbXRUZ2orTjg4QlIxRWFsTG40MVR1NUppYURHem1lelh2SU9Dc25SVGs4MTBLcXc3TU9lTDVUTGVaCm10czg2aHZDRjMyUlJET1J4VXVjeFpwWGIvTEhDc29jRHJ0MkpXSmVvVlJlSTl2dlpLb3JUcmx1N1RqNVhVOHgKMDJtTDQ1N3Z1dVZvWFN5QzdEYTBrVE5rblhQcFAwWlIzdXk0YWV6UUw3OVFvV3JGSmhoK25COUtRTjMvbDhQaApybDNRbDBvRzYrR0JSVlRHbW9oOWNVcUx5NkNvUDhmNmpXNG1LeUZwS2ZKSW81cEFGNUdQNGZFYTlnPT0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
type: kubernetes.io/tls
```

Apply Secret

```bash
kubectl apply -f secret.yaml
```

Fanout ingress plus all services and pods

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
  labels:
    app: pod1
spec:
  containers:
  - image: shekeriev/k8s-environ
    name: main
    env:
    - name: TOPOLOGY
      value: "POD1 -> SERVICE1"
    - name: FOCUSON
      value: "TOPOLOGY"
---
apiVersion: v1
kind: Service
metadata:
  name: service1
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    app: pod1  
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
  labels:
    app: pod2
spec:
  containers:
  - image: shekeriev/k8s-environ
    name: main
    env:
    - name: TOPOLOGY
      value: "POD2 -> SERVICE2"
    - name: FOCUSON
      value: "TOPOLOGY"
---
apiVersion: v1
kind: Service
metadata:
  name: service2
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    app: pod2
---
apiVersion: v1
kind: Pod
metadata:
  name: podd
  labels:
    app: podd
spec:
  containers:
  - image: shekeriev/k8s-environ
    name: main
    env:
    - name: TOPOLOGY
      value: "PODd -> SERVICEd (default backend)"
    - name: FOCUSON
      value: "TOPOLOGY"
---
apiVersion: v1
kind: Service
metadata:
  name: serviced
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    app: podd
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-ctrl
  annotations:
    nginx.org/rewrites: "serviceName=service1 rewrite=/;serviceName=service2 rewrite=/"
spec:
  # TLS Configuration
  tls:
  - hosts:
    - demo.lab
    secretName: demo-lab-secret
  ingressClassName: nginx
  defaultBackend:
    service:
      name: serviced
      port:
        number: 443
  rules:
  - host: demo.lab
    http:
      paths:
      - path: /service1
        pathType: Prefix
        backend:
          service:
            name: service1
            port:
              number: 443
      - path: /service2
        pathType: Prefix
        backend:
          service:
            name: service2
            port:
              number: 443
```


Apply fanout ingress plus all services and pods

```bash
kubectl apply -f solution.yaml
```
